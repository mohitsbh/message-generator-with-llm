<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Message Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body { padding: 2rem; background: #f8f9fa; }
      .card-preview { min-height: 120px; white-space: pre-wrap; }
      .small-note { font-size: 0.9rem; color: #6c757d; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="d-flex align-items-center mb-3">
            <h1 class="h3 mb-0">Message Generator</h1>
            <span class="badge bg-info ms-3">LLM + Templates</span>
          </div>

          <div class="card shadow-sm mb-4">
            <div class="card-body">
              <label for="prompt" class="form-label">Prompt</label>
              <textarea id="prompt" class="form-control mb-2" rows="3" placeholder="e.g. Diwali wish for my customers"></textarea>

              <div class="row g-2 align-items-center mb-3">
                <div class="col-auto">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="useLLM">
                    <label class="form-check-label small-note" for="useLLM">Use LLM</label>
                  </div>
                </div>
                <div class="col-auto">
                  <select id="provider" class="form-select form-select-sm">
                    <option value="gemini">Gemini</option>
                    <option value="openai">OpenAI</option>
                  </select>
                </div>
                <div class="col text-end">
                  <div id="status" class="small-note">Ready</div>
                </div>
              </div>

              <div class="d-flex gap-2">
                <button id="gen" class="btn btn-primary">Generate</button>
                <button id="example" class="btn btn-outline-secondary">Example</button>
                <button id="clear" class="btn btn-outline-danger">Clear</button>
                <div id="spinner" class="spinner-border text-primary ms-auto" role="status" style="display:none; width:1.5rem; height:1.5rem;"></div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="card mb-3">
                <div class="card-header">Generated message</div>
                <div class="card-body">
                  <div id="output" class="card-preview">(generated message will appear here)</div>
                  <div class="mt-3 d-flex gap-2">
                    <button id="copy" class="btn btn-sm btn-outline-primary">Copy</button>
                    <button id="edit" class="btn btn-sm btn-outline-secondary">Edit</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card mb-3">
                <div class="card-header">Tweak & Save</div>
                <div class="card-body">
                  <textarea id="tweak" class="form-control mb-2" rows="6" placeholder="Make final edits here..."></textarea>
                  <div class="d-flex gap-2">
                    <button id="save" class="btn btn-success">Save to file</button>
                    <button id="downloadJson" class="btn btn-outline-success">Export JSON</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="mt-2 small-note">Tip: set your API keys in the server `.env` and use the provider dropdown. If an LLM is not configured, the app falls back to templates.</div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const gen = document.getElementById('gen');
      const out = document.getElementById('output');
      const promptEl = document.getElementById('prompt');
      const tweak = document.getElementById('tweak');
      const save = document.getElementById('save');
      const copyBtn = document.getElementById('copy');
      const editBtn = document.getElementById('edit');
      const spinner = document.getElementById('spinner');
      const status = document.getElementById('status');
      const example = document.getElementById('example');
      const clear = document.getElementById('clear');

      function setStatus(s) { status.textContent = s; }
      function showSpinner(v) { spinner.style.display = v ? 'inline-block' : 'none'; }

      // Helper: call serverless endpoint (/api/generate). If running locally (localhost) and serverless fails,
      // fall back to local Express endpoint (/generate). Always check response status and content-type before parsing.
      async function postGenerate(body) {
        const isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1';

        // Try serverless /api/generate first
        try {
          const r = await fetch('/api/generate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
          const ct = (r.headers.get('content-type') || '').toLowerCase();
          if (r.ok) {
            if (ct.includes('application/json')) return await r.json();
            // server returned non-JSON (likely an HTML error page)
            const txt = await r.text();
            throw new Error(`/api/generate returned ${r.status}: ${txt.slice(0, 200)}`);
          }
          // non-ok status
          const errTxt = await r.text();
          throw new Error(`/api/generate returned ${r.status}: ${errTxt.slice(0, 200)}`);
        } catch (err) {
          // If running locally, try fallback to /generate
          if (isLocal) {
            try {
              const r2 = await fetch('/generate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
              const ct2 = (r2.headers.get('content-type') || '').toLowerCase();
              if (r2.ok) {
                if (ct2.includes('application/json')) return await r2.json();
                const txt2 = await r2.text();
                throw new Error(`/generate returned ${r2.status}: ${txt2.slice(0,200)}`);
              }
              const errTxt2 = await r2.text();
              throw new Error(`/generate returned ${r2.status}: ${errTxt2.slice(0,200)}`);
            } catch (err2) {
              throw err2;
            }
          }
          // Not local or fallback didn't help â€” rethrow original error
          throw err;
        }
      }

      gen.addEventListener('click', async () => {
        const prompt = promptEl.value.trim();
        if (!prompt) { setStatus('Enter a prompt'); return; }
        const useLLM = document.getElementById('useLLM').checked;
        const provider = document.getElementById('provider').value;
        setStatus('Generating...'); showSpinner(true);
        gen.disabled = true;
        try {
          const data = await postGenerate({ prompt, useLLM, provider });
          out.textContent = data && data.message ? data.message : '(no message)';
          tweak.value = out.textContent;
          setStatus('Done');
        } catch (err) {
          setStatus('Error: ' + (err && err.message));
        } finally {
          showSpinner(false); gen.disabled = false;
        }
      });

      example.addEventListener('click', () => {
        promptEl.value = 'Diwali wish for my customers';
      });

      clear.addEventListener('click', () => {
        promptEl.value = '';
        out.textContent = '(generated message will appear here)';
        tweak.value = '';
        setStatus('Cleared');
      });

      copyBtn.addEventListener('click', async () => {
        try { await navigator.clipboard.writeText(out.textContent); setStatus('Copied to clipboard'); } catch (e) { setStatus('Copy failed'); }
      });

      editBtn.addEventListener('click', () => { tweak.focus(); });

      save.addEventListener('click', () => {
        const content = tweak.value || out.textContent;
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'message.txt'; document.body.appendChild(a); a.click(); a.remove();
        setStatus('Saved message.txt');
      });

      document.getElementById('downloadJson').addEventListener('click', () => {
        const payload = { prompt: promptEl.value, message: tweak.value || out.textContent, provider: document.getElementById('provider').value };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'message.json'; document.body.appendChild(a); a.click(); a.remove();
        setStatus('Exported message.json');
      });
    </script>
  </body>
</html>